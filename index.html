<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POKER VR MASTER - 1.5.4</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; }
    </style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

        // 1. CORE SETUP
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const cameraRig = new THREE.Group();
        cameraRig.add(camera);
        scene.add(cameraRig);

        // 2. ENVIRONMENT
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const grid = new THREE.GridHelper(100, 100, 0x00ffcc, 0x222222);
        scene.add(grid);

        // --- POKER TABLE ---
        const table = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 2.5, 0.2, 32), new THREE.MeshStandardMaterial({ color: 0x006400 }));
        table.position.set(0, 0.8, -5);
        scene.add(table);

        // --- STORE & DAILY PICK CHAIR ---
        // Store Wall
        const store = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 0.2), new THREE.MeshStandardMaterial({ color: 0x440000 }));
        store.position.set(-7, 1.5, -2);
        store.rotation.y = Math.PI / 4;
        scene.add(store);

        // Daily Pick Chair (The Daily Reward Station)
        const chairGroup = new THREE.Group();
        const seat = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.1, 0.8), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        const back = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.1), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        back.position.set(0, 0.5, -0.4);
        chairGroup.add(seat, back);
        chairGroup.position.set(-5, 0.4, -4); // Positioned near the store
        scene.add(chairGroup);

        // --- TELEPORT VISUALS ---
        // The Laser
        const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -1)]);
        const line = new THREE.Line(lineGeo);
        line.scale.z = 10;

        // The Land Spot (Teleport Marker)
        const markerGeo = new THREE.RingGeometry(0.3, 0.35, 32);
        const markerMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, side: THREE.DoubleSide });
        const marker = new THREE.Mesh(markerGeo, markerMat);
        marker.rotation.x = -Math.PI / 2;
        marker.visible = false;
        scene.add(marker);

        // Controllers
        const controller1 = renderer.xr.getController(0); // Right - Teleport
        controller1.add(line);
        cameraRig.add(controller1);

        const controller2 = renderer.xr.getController(1); // Left - Watch/Hand
        cameraRig.add(controller2);

        // Simple Hand Meshes
        const handMesh = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.15), new THREE.MeshStandardMaterial({ color: 0x00ffcc }));
        controller1.add(handMesh.clone());
        controller2.add(handMesh.clone());

        // --- LOGIC ---
        controller1.addEventListener('selectstart', () => {
            if (marker.visible) {
                cameraRig.position.set(marker.position.x, 0, marker.position.z);
            }
        });

        renderer.setAnimationLoop(() => {
            // Update Teleport Marker Position
            const matrix = new THREE.Matrix4().makeRotationFromQuaternion(controller1.quaternion);
            const dir = new THREE.Vector3(0, 0, -1).applyMatrix4(matrix);
            
            // Raycast to floor (y=0)
            if (dir.y < -0.1) {
                const ratio = -controller1.position.y / dir.y;
                const hitX = controller1.position.x + dir.x * ratio + cameraRig.position.x;
                const hitZ = controller1.position.z + dir.z * ratio + cameraRig.position.z;
                marker.position.set(hitX, 0.01, hitZ);
                marker.visible = true;
            } else {
                marker.visible = false;
            }

            // Sitting Height at Poker Table
            const distToTable = cameraRig.position.distanceTo(table.position);
            camera.position.y = (distToTable < 2.8) ? -0.2 : 0;
            
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
