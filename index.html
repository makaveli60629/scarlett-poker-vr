<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker VR 1.8 - Permanent Unified Build</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; }
        /* Force the VR button to be visible even if the screen is blue */
        #VRButton { 
            bottom: 50px !important; 
            border: 2px solid white !important; 
            background: rgba(0,0,0,0.8) !important; 
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        let scene, camera, renderer, controller1, controller2, raycaster;
        const tempMatrix = new THREE.Matrix4();

        // Game State for the Wrist Watch
        const stats = { money: 5000, chips: 1, rank: "Pro" };

        init();

        function init() {
            // 1. SCENE & SKY
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky Blue

            // 2. CAMERA
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 3);

            // 3. RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 4. VR BUTTON (CRITICAL FIX)
            const vrBtn = VRButton.createButton(renderer);
            document.body.appendChild(vrBtn);

            // 5. LIGHTING
            const ambient = new THREE.HemisphereLight(0xffffff, 0x444444, 3);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 2);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            // 6. THE WORLD (Lobby, Walls, Trims)
            createEnvironment();

            // 7. OCULUS CONTROLLERS & TELEPORT
            setupVR();

            renderer.setAnimationLoop(render);
        }

        function createEnvironment() {
            // FLOOR
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(40, 40),
                new THREE.MeshStandardMaterial({ color: 0x444444 })
            );
            floor.rotation.x = -Math.PI / 2;
            floor.name = "Floor";
            scene.add(floor);

            // ROOM 1: LOBBY (Brick Red Walls)
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x8B0000 });
            const backWall = new THREE.Mesh(new THREE.BoxGeometry(10, 3, 0.2), wallMat);
            backWall.position.set(0, 1.5, -5);
            scene.add(backWall);

            // FLOOR TRIM (Black)
            const trim = new THREE.Mesh(new THREE.BoxGeometry(10.1, 0.15, 0.1), new THREE.MeshStandardMaterial({color: 0x000000}));
            trim.position.set(0, 0.075, -4.9);
            scene.add(trim);

            // THE POKER TABLE
            const table = new THREE.Mesh(
                new THREE.CylinderGeometry(1.2, 1.2, 0.2, 32),
                new THREE.MeshStandardMaterial({ color: 0x006400 })
            );
            table.position.set(0, 0.8, 0);
            scene.add(table);

            // THE TELEPHONE
            const phone = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.1, 0.2), new THREE.MeshStandardMaterial({color: 0x222222}));
            phone.position.set(1.5, 0.9, 0);
            scene.add(phone);

            // THE GOLD EVENT CHIP ($5 Value)
            const chip = new THREE.Mesh(
                new THREE.CylinderGeometry(0.05, 0.05, 0.02, 32),
                new THREE.MeshStandardMaterial({ color: 0xFFD700, metalness: 0.8, roughness: 0.2 })
            );
            chip.position.set(0, 0.91, -0.5);
            scene.add(chip);

            // FLOATING STORE MENU
            const menu = new THREE.Mesh(
                new THREE.PlaneGeometry(1.5, 1),
                new THREE.MeshStandardMaterial({ color: 0x0000FF, transparent: true, opacity: 0.8 })
            );
            menu.position.set(-2, 1.8, -2);
            menu.rotation.y = 0.5;
            scene.add(menu);
        }

        function setupVR() {
            const factory = new XRControllerModelFactory();

            // Right Controller (Teleport)
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('selectstart', () => {
                tempMatrix.identity().extractRotation(controller1.matrixWorld);
                raycaster.ray.origin.setFromMatrixPosition(controller1.matrixWorld);
                raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
                const intersects = raycaster.intersectObjects(scene.children);
                for (let i = 0; i < intersects.length; i++) {
                    if (intersects[i].object.name === "Floor
