<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Poker VR - 9.4 Full Visibility</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

        let scene, camera, renderer, cameraRig, hand1, hand2;
        let snapTurned = false;

        // --- 1. THE LOBBY (Walls, Floor, Lights) ---
        function buildLobby() {
            // SKY / BACKGROUND
            scene.background = new THREE.Color(0x1a0a00); // Sunset Warmth

            // LIGHTS (Critical Fix)
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5); // Bright Sky Light
            scene.add(hemiLight);

            const sun = new THREE.DirectionalLight(0xffaa00, 1.0);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            // WALLS (Brighter Gray for Visibility)
            const wallMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
            const createWall = (x, z, ry) => {
                const wall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), wallMat);
                wall.position.set(x, 5, z);
                wall.rotation.y = ry;
                scene.add(wall);
            };
            createWall(0, -10, 0);          // Front
            createWall(0, 10, Math.PI);      // Back
            createWall(-10, 0, Math.PI/2);   // Left
            createWall(10, 0, -Math.PI/2);  // Right

            // FLOOR (Polished Wood style)
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(20, 20),
                new THREE.MeshStandardMaterial({ color: 0x1a0f00, metalness: 0.5, roughness: 0.2 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // THE POKER TABLE
            const table = new THREE.Group();
            const felt = new THREE.Mesh(new THREE.CylinderGeometry(1.6, 1.6, 0.1, 32), new THREE.MeshPhongMaterial({color: 0x07331a}));
            table.add(felt);
            table.position.y = 0.8;
            scene.add(table);

            // NEON STRIPS (Cyan)
            [[-9.9, -9.9], [9.9, -9.9], [9.9, 9.9], [-9.9, 9.9]].forEach(pos => {
                const neon = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 10), new THREE.MeshBasicMaterial({color: 0x00ffff}));
                neon.position.set(pos[0], 5, pos[1]);
                scene.add(neon);
            });
        }

        // --- 2. ENGINE INIT ---
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            cameraRig = new THREE.Group();
            cameraRig.position.set(0, 0, 4); // Spawns you away from the table
            cameraRig.add(camera);
            scene.add(cameraRig);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            document.body.appendChild(VRButton.createButton(renderer));

            // Hand Models
            const handFactory = new XRHandModelFactory();
            hand1 = renderer.xr.getHand(0); hand1.add(handFactory.createHandModel(hand1, "mesh")); cameraRig.add(hand1);
            hand2 = renderer.xr.getHand(1); hand2.add(handFactory.createHandModel(hand2, "mesh")); cameraRig.add(hand2);

            buildLobby();
            renderer.setAnimationLoop(render);
        }

        // --- 3. MOVEMENT LOGIC ---
        function render() {
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    if (source.gamepad) {
                        const axes = source.gamepad.axes; // [lx, ly, rx, ry]
                        
                        // LEFT STICK: Move in head direction
                        const moveX = axes[0] || 0;
                        const moveZ = axes[1] || 0;
                        if (Math.abs(moveX) > 0.1 || Math.abs(moveZ) > 0.1) {
                            const speed = 0.04;
                            const headRotation = new THREE.Quaternion();
                            camera.getWorldQuaternion(headRotation);
                            
                            const direction = new THREE.Vector3(moveX, 0, moveZ).applyQuaternion(headRotation);
                            direction.y = 0; // Keep on ground
                            cameraRig.position.add(direction.multiplyScalar(speed));
                        }

                        // RIGHT STICK: Snap Turn
                        const rotateX = axes[2] || 0;
                        if (Math.abs(rotateX) > 0.8 && !snapTurned) {
                            cameraRig.rotation.y -= Math.sign(rotateX) * (Math.PI / 4);
                            snapTurned = true;
                        } else if (Math.abs(rotateX) < 0.1) {
                            snapTurned = false;
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
