<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Brick Club VR - Movement Recovery</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #overlay { position: absolute; width: 100%; height: 100%; display: flex; 
                   justify-content: center; align-items: center; background: #000; z-index: 100; color: #ffd700; font-family: sans-serif;}
        button { padding: 25px 50px; font-size: 24px; background: #8B0000; color: white; border-radius: 50px; border: 2px solid gold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="overlay"><button id="start-btn">ENABLE MOVEMENT & ENTER</button></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { VRButton } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/VRButton.js';

        let scene, camera, renderer, userRig, moveHighlight;
        let canTurn = true;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111); 

            // 1. THE RIG (Your VR Body)
            userRig = new THREE.Group();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            userRig.add(camera);
            userRig.position.set(0, 1.6, 5); 
            scene.add(userRig);

            // 2. THE RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);
            document.body.appendChild(VRButton.createButton(renderer));

            // 3. LIGHTS
            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(5, 10, 5);
            scene.add(sun);

            // 4. ENVIRONMENT (Red Floor & Brick Wall)
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x800000}));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            const wall = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 1), new THREE.MeshStandardMaterial({color: 0x552222}));
            wall.position.set(0, 5, -5); 
            scene.add(wall);

            // 5. MOVEMENT HIGHLIGHT (Blue Ring)
            const ringGeo = new THREE.RingGeometry(0.3, 0.4, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, side: THREE.DoubleSide });
            moveHighlight = new THREE.Mesh(ringGeo, ringMat);
            moveHighlight.rotation.x = -Math.PI / 2;
            moveHighlight.position.y = 0.05;
            scene.add(moveHighlight);

            renderer.setAnimationLoop(renderLoop);
        }

        function renderLoop() {
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    if (!source.gamepad) continue;
                    const axes = source.gamepad.axes; 

                    // LEFT STICK: Walk
                    if (source.handedness === 'left') {
                        const speed = 0.08;
                        // Move based on where the camera is facing
                        const direction = new THREE.Vector3(axes[2], 0, axes[3]);
                        direction.applyQuaternion(userRig.quaternion);
                        userRig.position.addScaledVector(direction, speed);
                        
                        // Sync highlight to feet
                        moveHighlight.position.set(userRig.position.x, 0.05, userRig.position.z);
                    }

                    // RIGHT STICK: Snap Turn
                    if (source.handedness === 'right') {
                        if (canTurn && Math.abs(axes[2]) > 0.7) {
                            userRig.rotation.y -= Math.sign(axes[2]) * (Math.PI / 4);
                            canTurn = false;
                            setTimeout(() => { canTurn = true; }, 300);
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        }

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            init();
        };
    </script>
</body>
</html>
