<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Poker - Brick Club 111</title>
    <style>
        body { margin: 0; background-color: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #overlay {
            position: absolute; width: 100%; height: 100%; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://threejs.org/examples/textures/brick_diffuse.jpg');
            background-size: cover; z-index: 20;
        }
        #play-btn {
            padding: 25px 60px; font-size: 32px; background: #b22222;
            color: white; border: 4px solid #fff; border-radius: 15px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); font-weight: bold;
        }
        #play-btn:hover { background: #ff0000; transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 50px; text-shadow: 2px 2px #000;">BRICK CLUB POKER</h1>
        <button id="play-btn">PLAY VR (AUTO-SIT)</button>
        <p>Ensure your headset is connected</p>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { VRButton } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/VRButton.js';

        let scene, camera, renderer, menuGroup, backDoor;
        let isMenuOpen = false;
        let isDoorOpen = false;

        // 1. ENGINE STARTUP
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Add the VR Button (Crucial for Meta Quest)
            document.body.appendChild(VRButton.createButton(renderer));

            // LIGHTING
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            const spot = new THREE.PointLight(0xffffff, 1);
            spot.position.set(0, 5, -3);
            scene.add(ambient, spot);

            buildEnvironment();
            createBrandedTable();
            createVRMenu();
            setupControllers();

            renderer.setAnimationLoop(render);
        }

        // 2. ENVIRONMENT (4 Brick Zones)
        function buildEnvironment() {
            const loader = new THREE.TextureLoader();
            const brickTex = loader.load('https://threejs.org/examples/textures/brick_diffuse.jpg');
            const brickMat = new THREE.MeshStandardMaterial({ map: brickTex, side: THREE.DoubleSide });

            // Lobby + 3 Rooms
            for(let i = 0; i < 4; i++) {
                const room = new THREE.Mesh(new THREE.BoxGeometry(10, 6, 12), brickMat);
                room.position.z = -(i * 12.5);
                scene.add(room);
            }

            // THE BACK DOOR
            const doorGeo = new THREE.BoxGeometry(1.5, 3, 0.1);
            const doorMat = new THREE.MeshStandardMaterial({ color: 0x442211 });
            backDoor = new THREE.Mesh(doorGeo, doorMat);
            backDoor.position.set(-4.9, 1.5, -5); // On the wall
            scene.add(backDoor);
        }

        // 3. TABLE & CARDS
        function createBrandedTable() {
            const table = new THREE.Group();
            const felt = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 0.2, 32), new THREE.MeshStandardMaterial({color: 0x076324}));
            
            // Branding Logo Overlay
            const logo = new THREE.Mesh(new THREE.CircleGeometry(0.6, 32), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 }));
            logo.rotation.x = -Math.PI / 2;
            logo.position.y = 0.11;
            
            table.add(felt, logo);
            table.position.set(0, 0, -5);
            scene.add(table);
        }

        // 4. MENU & LEAVE BUTTON
        function createVRMenu() {
            menuGroup = new THREE.Group();
            const bg = new THREE.Mesh(new THREE.PlaneGeometry(0.6, 0.4), new THREE.MeshBasicMaterial({color: 0x222222, transparent: true, opacity: 0.9}));
            
            const leaveBtn = new THREE.Mesh(new THREE.PlaneGeometry(0.4, 0.1), new THREE.MeshBasicMaterial({color: 0xff0000}));
            leaveBtn.position.z = 0.01;
            leaveBtn.name = "LEAVE_BTN";

            menuGroup.add(bg, leaveBtn);
            menuGroup.visible = false;
            scene.add(menuGroup);
        }

        // 5. OCULUS CONTROL LOGIC
        function setupControllers() {
            // LEFT CONTROLLER (Menu & Door)
            const cLeft = renderer.xr.getController(0);
            cLeft.addEventListener('selectstart', () => {
                if(isMenuOpen) exitGame(); // Click Leave inside menu
                else toggleMenu();         // Toggle Menu open
            });
            cLeft.addEventListener('squeezestart', toggleDoor); // Side Grip for Back Door
            scene.add(cLeft);

            // RIGHT CONTROLLER (Daily Giveaway)
            const cRight = renderer.xr.getController(1);
            cRight.addEventListener('selectstart', spawnBlueChips); // A Button / Trigger
            scene.add(cRight);
        }

        function toggleMenu() {
            isMenuOpen = !isMenuOpen;
            menuGroup.visible = isMenuOpen;
            const head = renderer.xr.getCamera(camera);
            menuGroup.position.set(head.position.x, head.position.y, head.position.z - 0.8);
            menuGroup.quaternion.copy(head.quaternion);
        }

        function toggleDoor() {
            isDoorOpen = !isDoorOpen;
            backDoor.rotation.y = isDoorOpen ? Math.PI / 2 : 0;
            backDoor.position.x = isDoorOpen ? -5.5 : -4.9;
        }

        function spawnBlueChips() {
            // BLUE GIVEAWAY LOGIC
            const chip = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.02), new THREE.MeshStandardMaterial({color: 0x0000ff}));
            chip.position.set(0, 1.2, -4.5);
            scene.add(chip);
        }

        function exitGame() {
            const session = renderer.xr.getSession();
            if (session) {
                session.end().then(() => {
                    window.location.reload(); // Hard reset clears white screen
                });
            }
        }

        function render() {
            renderer.render(scene, camera);
        }

        // 6. PLAY GAME / AUTO-SIT
        document.getElementById('play-btn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            // Auto-Sit coordinates
            camera.position.set(0, 1.2, -4); 
            // The browser requires a user gesture to start VR
            const sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };
            navigator.xr.requestSession('immersive-vr', sessionInit).then(s => {
                renderer.xr.setSession(s);
            });
        };

        init();
    </script>
</body>
</html>
