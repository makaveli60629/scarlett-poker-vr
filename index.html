<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POKER VR MASTER - 1.9.3</title>
    <style> body { margin: 0; background-color: #000; overflow: hidden; } </style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';
        import { Reflector } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/objects/Reflector.js';

        // 1. DATA & LOCKER SYSTEM
        let stats = JSON.parse(localStorage.getItem('poker_master_save')) || { 
            chips: 500, rank: "Rookie", name: "Player 1", 
            inventory: ["default_shirt"], activeGear: "default_shirt" 
        };
        
        const runTransaction = (amount, itemId = null) => {
            if (stats.chips >= Math.abs(amount)) {
                stats.chips += amount;
                if(itemId) stats.inventory.push(itemId);
                localStorage.setItem('poker_master_save', JSON.stringify(stats));
                updateWatchUI();
                return true;
            }
            return false;
        };

        const texLoader = new THREE.TextureLoader();
        const path = 'assets/textures/';
        const tex = {
            brick: texLoader.load(path + 'brickwall.jpg'),
            carpet: texLoader.load(path + 'lobby_carpet.jpg'),
            felt: texLoader.load(path + 'table_felt_green.jpg'),
            logo: texLoader.load(path + 'brand_logo.jpg')
        };
        [tex.brick, tex.carpet].forEach(t => { t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(10, 10); });

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const cameraRig = new THREE.Group();
        cameraRig.position.set(0, 0, 10);
        cameraRig.add(camera);
        scene.add(cameraRig);
        scene.add(new THREE.HemisphereLight(0xffffff, 0x222222, 2));

        // 2. THE STORE & DRESSING ROOM AREA
        const lobbySize = 70;
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(lobbySize, lobbySize), new THREE.MeshStandardMaterial({ map: tex.carpet }));
        floor.rotation.x = -Math.PI/2; scene.add(floor);

        // MIRROR (The Locker Area)
        const mirror = new Reflector(new THREE.PlaneGeometry(4, 7), {
            clipBias: 0.003, textureWidth: window.innerWidth * window.devicePixelRatio,
            textureHeight: window.innerHeight * window.devicePixelRatio, color: 0x889999
        });
        mirror.position.set(-30, 3.5, -20);
        mirror.rotation.y = Math.PI / 4;
        scene.add(mirror);

        const lockerSign = createLabel("YOUR LOCKER", 3);
        lockerSign.position.set(-28, 8, -18); scene.add(lockerSign);

        // 3. STORE INTERFACE (Hologram)
        const storeMenu = new THREE.Group();
        const storeCanvas = document.createElement('canvas');
        storeCanvas.width = 512; storeCanvas.height = 512;
        const sCtx = storeCanvas.getContext('2d');
        const storeTex = new THREE.CanvasTexture(storeCanvas);
        const storeMesh = new THREE.Mesh(new THREE.PlaneGeometry(3, 3), new THREE.MeshBasicMaterial({ map: storeTex, transparent: true }));
        storeMenu.add(storeMesh);
        storeMenu.position.set(25, 2, -25);
        scene.add(storeMenu);

        function updateStoreUI() {
            sCtx.clearRect(0,0,512,512);
            sCtx.fillStyle = "rgba(0, 0, 20, 0.8)"; sCtx.fillRect(0,0,512,512);
            sCtx.strokeStyle = "#00ffff"; sCtx.lineWidth = 10; sCtx.strokeRect(5,5,502,502);
            sCtx.fillStyle = "#fff"; sCtx.font = "bold 40px Arial";
            sCtx.fillText("MALL STORE", 150, 60);
            // Item 1
            sCtx.fillStyle = "#333"; sCtx.fillRect(50, 100, 412, 120);
            sCtx.fillStyle = "#fff"; sCtx.fillText("Gold Watch - $2000", 70, 150);
            sCtx.font = "20px Arial"; sCtx.fillText("CLICK TO BUY", 70, 190);
            storeTex.needsUpdate = true;
        }
        updateStoreUI();

        // 4. WRIST WATCH (Y-BUTTON)
        const watchGroup = new THREE.Group();
        const watchCanvas = document.createElement('canvas');
        watchCanvas.width = 512; watchCanvas.height = 512;
        const wCtx = watchCanvas.getContext('2d');
        const watchTex = new THREE.CanvasTexture(watchCanvas);
        const watchMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.25, 0.25), new THREE.MeshBasicMaterial({ map: watchTex, transparent: true }));
        watchMesh.position.set(0, 0.05, 0); watchMesh.rotation.x = -Math.PI/2;
        watchGroup.add(watchMesh); watchGroup.visible = false;

        function updateWatchUI() {
            wCtx.clearRect(0,0,512,512);
            wCtx.fillStyle = "rgba(0,0,0,0.9)"; wCtx.beginPath(); wCtx.roundRect(10,10,492,492,40); wCtx.fill();
            wCtx.strokeStyle = "#00ffff"; wCtx.lineWidth = 10; wCtx.stroke();
            wCtx.fillStyle = "#fff"; wCtx.font = "40px Arial";
            wCtx.fillText(`Wallet: $${stats.chips}`, 50, 100);
            wCtx.fillStyle = "#800080"; wCtx.fillRect(50, 350, 412, 100);
            wCtx.fillStyle = "#fff"; wCtx.fillText("RETURN TO LOBBY", 80, 415);
            watchTex.needsUpdate = true;
        }

        // 5. CONTROLS (LEFT TRIGGER NAV)
        const controllerL = renderer.xr.getController(1);
        controllerL.add(watchGroup);
        cameraRig.add(controllerL);
        const controllerR = renderer.xr.getController(0);
        cameraRig.add(controllerR);

        const marker = new THREE.Mesh(new THREE.RingGeometry(0.4, 0.5, 32), new THREE.MeshBasicMaterial({ color: 0x00ffcc }));
        marker.rotation.x = -Math.PI/2; scene.add(marker);

        function createLabel(text, size) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.fillStyle = "white"; ctx.font = "bold 60px Arial"; ctx.fillText(text, 10, 80);
            const tex = new THREE.CanvasTexture(canvas);
            return new THREE.Mesh(new THREE.PlaneGeometry(size, size/4), new THREE.MeshBasicMaterial({map:tex, transparent:true}));
        }

        const raycaster = new THREE.Raycaster();
        renderer.setAnimationLoop(() => {
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    const b = source.gamepad.buttons;
                    if (source.handedness === 'left') {
                        // Teleport Marker
                        const m = new THREE.Matrix4().extractRotation(controllerL.matrixWorld);
                        raycaster.ray.origin.setFromMatrixPosition(controllerL.matrixWorld);
                        raycaster.ray.direction.set(0, 0, -1).applyMatrix4(m);
                        const fHits = raycaster.intersectObject(floor);
                        if (fHits.length > 0) { marker.position.copy(fHits[0].point); marker.visible = true; }

                        // Trigger (0) - Jump / Store Buy
                        if (b[0].pressed) {
                            const storeHits = raycaster.intersectObject(storeMesh);
                            if(storeHits.length > 0) {
                                runTransaction(-2000, "gold_watch");
                            } else {
                                cameraRig.position.set(marker.position.x, 0, marker.position.z);
                            }
                        }
                        // Y Button (5)
                        watchGroup.visible = b[5].pressed;
                        if(watchGroup.visible) updateWatchUI();
                    }
                    if (source.handedness === 'right' && source.gamepad.axes[2] > 0.8) {
                         cameraRig.rotation.y -= 0.05; // Smooth turn
                    }
                }
            }
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
