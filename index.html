<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Scarlett Avatar Lab — Permanent Spine</title>
  <style>
    :root{
      --hudScale: 1;

      --cyan:#00ffff;
      --bg: rgba(10,16,32,0.88);
      --panelW: min(360px, calc(100vw - 24px));
    }
    html,body{ margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; touch-action:none; font-family: monospace; }
    #app{ position:fixed; inset:0; z-index:1; }
    /* HUD overlay */
    #hud{
      position: fixed; top: 10px; left: 10px; z-index: 9999;
      width: var(--panelW);
      background: var(--bg);
      border: 1px solid var(--cyan);
      padding: 12px;
      border-radius: 12px;
      color: var(--cyan);
      box-shadow: 0 0 24px rgba(0,255,255,0.12);
      pointer-events: auto; /* allow button presses */
    }
    #hud.compact #hudBody{ display:none; }
    #hud.off{ display:none; }
    #hudTitle{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    #hudTitle h2{ margin:0; font-size:13px; letter-spacing:0.5px; }
    #hudSub{ margin-top:6px; font-size:11px; opacity:0.9; line-height:1.25; }
    #hudlog{
      height: 120px; overflow-y:auto; background:#000; font-size:10px;
      margin-top:10px; padding:6px; border:1px solid #333; color:#00ff41;
      border-radius: 8px;
      -webkit-overflow-scrolling: touch;
    }
    .btnRow{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .btn{
      flex: 1 1 auto;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-weight: 800;
      cursor: pointer;
      background: var(--cyan);
      color:#000;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-width: 120px;
    }
    .btn.secondary{ background: transparent; color: var(--cyan); border:1px solid rgba(0,255,255,0.6); }
    .btn.danger{ background: #ff4d4d; color:#000; }
    .sliderRow{ margin-top:10px; }
    .sliderRow label{ display:block; font-size:12px; margin-bottom:4px; color: var(--cyan); opacity:0.95; }
    input[type="range"]{ width:100%; }
    #tinyToggle{
      position: fixed;
      top: 12px; right: 12px;
      z-index: 10000;
      width: 44px; height: 44px;
      border-radius: 999px;
      border:1px solid rgba(0,255,255,0.7);
      background: rgba(10,16,32,0.65);
      color: var(--cyan);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      pointer-events:auto;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    /* allow the canvas to receive touches when HUD is off */
    body.hudOff #app{ z-index: 10; }
    /* mobile-friendly: keep HUD smaller */
    @media (max-width: 420px){
      #hudlog{ height: 98px; }
      .btn{ padding: 9px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="tinyToggle" title="Toggle HUD">⚙️</div>

  <div id="hud" class="">
    <div id="hudTitle">
      <h2>SCARLETT AVATAR LAB — PERMANENT SPINE</h2>
      <div style="font-size:11px; opacity:0.85;" id="hudMini">BOOTING…</div>
    </div>

    <div id="hudBody">
      <div id="hudSub">
        Desktop: WASD + Mouse (drag) • Android: Touch Joystick + Drag Look • Quest: Enter VR (HUD auto-hides)
      </div>

      <div class="btnRow">
        <button class="btn secondary" id="btnCompact">COMPACT</button>
        <button class="btn secondary" id="btnCopy">COPY LOG</button>
          <button class="btn secondary" id="btnHudSize">HUD SIZE</button>
      </div>

      <div class="btnRow">
        <button class="btn" id="btnPlay">PLAY (HIDE HUD)</button>
        <button class="btn danger" id="btnShow">SHOW HUD</button>
      </div>

      <div class="btnRow">
        <button class="btn secondary" id="btnReloadModules">RELOAD MODULES</button>
      </div>

      
      <div style="margin-top:10px; padding:10px; border:1px solid rgba(0,255,255,0.25); border-radius:10px;">
        <div style="font-size:12px; margin-bottom:6px; color:var(--cyan);">AVATAR QUICK LOAD</div>
        <input id="avatarUrl" placeholder="GLB/GLTF URL or path (e.g. assets/avatar.glb)" 
               style="width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid rgba(0,255,255,0.35); background:rgba(0,0,0,0.35); color:var(--cyan);" />
        <div class="btnRow" style="margin-top:8px;">
          <button class="btn" id="btnLoadAvatar">LOAD AVATAR</button>
          <button class="btn secondary" id="btnClearAvatar">CLEAR</button>
        </div>
        <div class="btnRow" style="margin-top:8px;">
          <button class="btn secondary" id="btnLoadPackMale">free_pack_male_base_mesh.glb</button>
          <button class="btn secondary" id="btnLoadMaleMesh">models/male_mesh.glb</button>
        </div>
        <div class="btnRow" style="margin-top:8px;">
          <button class="btn secondary" id="btnLoadJinRoh">models/combat_ninja_jin_roh.glb</button>
        </div>
        <div style="font-size:10px; opacity:0.85; margin-top:6px;">
          Tip: These are just file paths. Make sure the GLBs exist in your repo at those locations.
        </div>
      </div>

      <div id="hudlog">INITIALIZING…</div>
    </div>
  </div>

  <script type="module" src="./app.mjs"></script>

  <script>
    // HUD + log helpers (touch safe)
    const hud = document.getElementById('hud');
    const tiny = document.getElementById('tinyToggle');
    const logEl = document.getElementById('hudlog');
    const mini = document.getElementById('hudMini');

    function setHudMode(mode){
      hud.classList.remove('compact','off');
      document.body.classList.remove('hudOff');
      if(mode === 'compact') hud.classList.add('compact');
      if(mode === 'off'){ hud.classList.add('off'); document.body.classList.add('hudOff'); }
    }
    function toggleHud(){
      if(hud.classList.contains('off')) setHudMode('compact');
      else if(hud.classList.contains('compact')) setHudMode('off');
      else setHudMode('compact');
    }

    // make clicks work reliably on mobile
    function bindBtn(id, fn){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', fn, { passive:true });
      el.addEventListener('touchend', (e)=>{ e.preventDefault(); fn(); }, { passive:false });
    }

    bindBtn('btnPlay', ()=> setHudMode('off'));
    bindBtn('btnShow', ()=> setHudMode(''));
    bindBtn('btnCompact', ()=> setHudMode(hud.classList.contains('compact') ? '' : 'compact'));
    bindBtn('btnCopy', async ()=>{
      const txt = (logEl?.innerText || '').trim();
      try{
        await navigator.clipboard.writeText(txt);
        mini.textContent = 'LOG COPIED ✅';
        setTimeout(()=>mini.textContent='OK', 900);
      }catch(e){
        // fallback prompt
        window.prompt("Copy log:", txt);
      }
    });
    
    const avatarUrl = document.getElementById('avatarUrl');
    function requestLoad(path){
      if(avatarUrl) avatarUrl.value = path;
      window.dispatchEvent(new CustomEvent('scarlett:loadAvatar', { detail: { url: path }}));
      mini.textContent = 'LOADING AVATAR…';
      setTimeout(()=>mini.textContent='OK', 900);
    }
    bindBtn('btnLoadAvatar', ()=> requestLoad((avatarUrl?.value || '').trim()));
    bindBtn('btnClearAvatar', ()=> window.dispatchEvent(new CustomEvent('scarlett:clearAvatar')));
    bindBtn('btnLoadPackMale', ()=> requestLoad('assets/free_pack_male_base_mesh.glb'));
    bindBtn('btnLoadMaleMesh', ()=> requestLoad('assets/models/male_mesh.glb'));
    bindBtn('btnLoadJinRoh', ()=> requestLoad('assets/models/combat_ninja_inspired_by_jin_roh_wolf_brigade.glb'));

    bindBtn('btnReloadModules', ()=>{
      window.dispatchEvent(new CustomEvent('scarlett:reloadModules'));
      mini.textContent = 'RELOADING…';
      setTimeout(()=>mini.textContent='OK', 800);
    });
    tiny.addEventListener('click', toggleHud);
    tiny.addEventListener('touchend', (e)=>{ e.preventDefault(); toggleHud(); }, { passive:false });

    // expose a safe logger for modules
    window.__scarlettLog = function(msg){
      const line = String(msg);
      if(mini) mini.textContent = 'OK';
      if(!logEl) return;
      logEl.innerText += (logEl.innerText ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
    };

  </script>
</body>
</html>
