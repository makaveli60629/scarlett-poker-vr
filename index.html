<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Stakes VR - Permanent Restoration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #enter-vr { 
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 20px 40px; font-size: 20px; background: #076324; color: white; border: none; cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="enter-vr">ENTER POKER ROOM</button>
<script>
    let scene, camera, renderer, userGroup;
    let handLeft, handRight;
    let menuGroup, isMenuOpen = false;

    // --- INITIALIZE ENGINE ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        userGroup = new THREE.Group();
        userGroup.add(camera);
        scene.add(userGroup);

        // Permanent Starting Position (In the Lobby area)
        userGroup.position.set(0, 1.6, 8);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        document.getElementById('enter-vr').addEventListener('click', () => {
            navigator.xr.requestSession('immersive-vr', {
                optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
            }).then(session => {
                renderer.xr.setSession(session);
                document.getElementById('enter-vr').style.display = 'none';
            });
        });

        setupLighting();
        buildRoom();
        createPokerArea();
        createStoreArea();
        setupHands();
        createVRMenu();
        
        animate();
    }

    // --- 1. FULL LIGHTING ---
    function setupLighting() {
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);

        const tableSpot = new THREE.SpotLight(0xffffff, 1.2);
        tableSpot.position.set(0, 5, -5);
        tableSpot.angle = Math.PI / 4;
        scene.add(tableSpot);

        const storeLight = new THREE.PointLight(0xffaa00, 0.8);
        storeLight.position.set(8, 3, -2);
        scene.add(storeLight);
    }

    // --- 2. ARCHITECTURE (The Four Walls) ---
    function buildRoom() {
        const wallMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a });
        
        // Floor
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.MeshStandardMaterial({color: 0x111111}));
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Back Wall
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 10), wallMat);
        backWall.position.set(0, 5, -15);
        scene.add(backWall);

        // Left & Right Walls
        const sideWallGeo = new THREE.PlaneGeometry(30, 10);
        const wallL = new THREE.Mesh(sideWallGeo, wallMat);
        wallL.rotation.y = Math.PI / 2;
        wallL.position.set(-15, 5, 0);
        scene.add(wallL);

        const wallR = wallL.clone();
        wallR.rotation.y = -Math.PI / 2;
        wallR.position.set(15, 5, 0);
        scene.add(wallR);

        // Ceiling
        const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), wallMat);
        ceiling.rotation.x = Math.PI / 2;
        ceiling.position.y = 10;
        scene.add(ceiling);
    }

    // --- 3. POKER AREA & HOVERING BOARD ---
    function createPokerArea() {
        const tableGroup = new THREE.Group();
        tableGroup.position.set(0, 0, -5);

        // Table
        const table = new THREE.Mesh(
            new THREE.CylinderGeometry(2.5, 2.5, 0.2, 64),
            new THREE.MeshStandardMaterial({ color: 0x076324 })
        );
        table.position.y = 1;
        tableGroup.add(table);

        // Leadership Board (Hovering)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 512; canvas.height = 256;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,512,256);
        ctx.fillStyle = 'gold'; ctx.font = 'bold 40px Arial';
        ctx.fillText('LEADERBOARD', 120, 80);
        const board = new THREE.Mesh(
            new THREE.PlaneGeometry(4, 2),
            new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas) })
        );
        board.position.set(0, 4, -4);
        tableGroup.add(board);

        // Aligned Chairs
        for(let i=0; i<6; i++) {
            const angle = (i/6) * Math.PI * 2;
            const chair = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), new THREE.MeshStandardMaterial({color: 0x333333}));
            chair.position.set(Math.cos(angle)*3.5, 0.3, Math.sin(angle)*3.5);
            tableGroup.add(chair);
        }
        scene.add(tableGroup);
    }

    // --- 4. STORE AREA ---
    function createStoreArea() {
        const store = new THREE.Group();
        store.position.set(10, 0, -2);
        const counter = new THREE.Mesh(new THREE.BoxGeometry(4, 1.2, 1), new THREE.MeshStandardMaterial({color: 0x4b3621}));
        counter.position.y = 0.6;
        store.add(counter);
        scene.add(store);
    }

    // --- 5. HANDS & MENU ---
    function setupHands() {
        handLeft = renderer.xr.getHand(0);
        handRight = renderer.xr.getHand(1);

        handLeft.addEventListener('pinchstart', () => {
            isMenuOpen = !isMenuOpen;
            menuGroup.visible = isMenuOpen;
            if(isMenuOpen) {
                const p = new THREE.Vector3();
                handLeft.getWorldPosition(p);
                menuGroup.position.set(p.x, p.y + 0.2, p.z - 0.2);
                menuGroup.lookAt(camera.position);
            }
        });

        scene.add(handLeft, handRight);
    }

    function createVRMenu() {
        menuGroup = new THREE.Group();
        const locations = [
            { name: 'Lobby', target: [0, 1.6, 8] },
            { name: 'Poker', target: [0, 1.6, -1] },
            { name: 'Store', target: [8, 1.6, -2] }
        ];

        locations.forEach((loc, i) => {
            const btn = new THREE.Mesh(
                new THREE.BoxGeometry(0.3, 0.1, 0.02),
                new THREE.MeshStandardMaterial({ color: 0x0000ff })
            );
            btn.position.y = 0.2 - (i * 0.15);
            btn.userData = { target: loc.target };
            menuGroup.add(btn);
        });
        menuGroup.visible = false;
        scene.add(menuGroup);
    }

    function checkMenuInteraction() {
        if (!isMenuOpen) return;
        const tip = handRight.joints ? handRight.joints['index-finger-tip'] : null;
        if (!tip || !tip.visible) return;

        menuGroup.children.forEach(btn => {
            const worldPos = new THREE.Vector3();
            btn.getWorldPosition(worldPos);
            if (tip.position.distanceTo(worldPos) < 0.05) {
                userGroup.position.set(...btn.userData.target);
                isMenuOpen = false;
                menuGroup.visible = false;
            }
        });
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            checkMenuInteraction();
            renderer.render(scene, camera);
        });
    }

    init();
</script>
</body>
</html>
