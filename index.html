<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High-Stakes VR - Night Sky v1.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 10; }
        button { padding: 20px; font-size: 20px; background: #076324; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="overlay"><button id="btn">ENTER VR NIGHT</button></div>
<script>
    let scene, camera, renderer, userGroup;
    let handL, handR, menuGroup;
    let isMenuOpen = false;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205); // Deep night
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        userGroup = new THREE.Group();
        userGroup.add(camera);
        scene.add(userGroup);
        userGroup.position.set(0, 0, 5); // Safe spawn

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        document.getElementById('btn').onclick = () => {
            navigator.xr.requestSession('immersive-vr', {
                optionalFeatures: ['local-floor', 'hand-tracking']
            }).then(s => {
                renderer.xr.setSession(s);
                document.getElementById('overlay').style.display = 'none';
            });
        };

        createEnvironment();
        setupHands();
        createVRMenu();
        animate();
    }

    function createEnvironment() {
        // Floor
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshStandardMaterial({color: 0x111111}));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);

        // THE MOON (Locking it in)
        const moon = new THREE.Mesh(
            new THREE.SphereGeometry(2, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0xffffaa })
        );
        moon.position.set(-10, 25, -20);
        scene.add(moon);
        
        // Moon Glow (Light)
        const moonLight = new THREE.DirectionalLight(0xaaaaff, 0.5);
        moonLight.position.copy(moon.position);
        scene.add(moonLight);

        // Poker Table
        const table = new THREE.Mesh(
            new THREE.CylinderGeometry(2.5, 2.5, 0.2, 32),
            new THREE.MeshStandardMaterial({ color: 0x076324 })
        );
        table.position.set(0, 1, -5);
        scene.add(table);

        // 6 Seats
        for(let i=0; i<6; i++) {
            const a = (i/6) * Math.PI * 2;
            const s = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color: 0x222222}));
            s.position.set(Math.cos(a)*3.5, 0.25, Math.sin(a)*3.5 - 5);
            scene.add(s);
        }

        // Walls (Wait, you said no ceiling - keeping walls low for "rooftop" feel)
        const wall = new THREE.Mesh(new THREE.BoxGeometry(50, 2, 0.5), new THREE.MeshStandardMaterial({color: 0x1a1a1a}));
        wall.position.set(0, 1, -25);
        scene.add(wall);
    }

    function setupHands() {
        // Visual Fallback for hands
        const handGeo = new THREE.SphereGeometry(0.05, 8, 8);
        const handMat = new THREE.MeshBasicMaterial({color: 0xffffff});

        handL = renderer.xr.getHand(0);
        handR = renderer.xr.getHand(1);

        // Add visible spheres so you can ALWAYS see your hands
        handL.add(new THREE.Mesh(handGeo, handMat));
        handR.add(new THREE.Mesh(handGeo, handMat));

        handL.addEventListener('pinchstart', () => {
            isMenuOpen = !isMenuOpen;
            menuGroup.visible = isMenuOpen;
        });

        scene.add(handL, handR);
    }

    function createVRMenu() {
        menuGroup = new THREE.Group();
        const nav = ['Lobby', 'Poker', 'Store'];
        nav.forEach((name, i) => {
            const btn = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.1, 0.05), new THREE.MeshBasicMaterial({color: 0x0000ff}));
            btn.position.y = 0.2 - (i * 0.15);
            btn.userData = { name: name };
            menuGroup.add(btn);
        });
        menuGroup.visible = false;
        scene.add(menuGroup);
    }

    function updateMenuPosition() {
        if(isMenuOpen) {
            // Anchor menu to Left Hand position
            const pos = new THREE.Vector3();
            handL.getWorldPosition(pos);
            menuGroup.position.lerp(new THREE.Vector3(pos.x, pos.y + 0.2, pos.z - 0.2), 0.1);
            menuGroup.lookAt(camera.position);
        }
    }

    function checkInteraction() {
        const tip = handR.joints ? handR.joints['index-finger-tip'] : null;
        if (!tip || !isMenuOpen) return;

        menuGroup.children.forEach(btn => {
            const bPos = new THREE.Vector3();
            btn.getWorldPosition(bPos);
            if(tip.position.distanceTo(bPos) < 0.05) {
                // Teleport Logic
                if(btn.userData.name === 'Poker') userGroup.position.set(0, 0, -2);
                if(btn.userData.name === 'Lobby') userGroup.position.set(0, 0, 5);
                isMenuOpen = false;
                menuGroup.visible = false;
            }
        });
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            updateMenuPosition();
            checkInteraction();
            renderer.render(scene, camera);
        });
    }

    init();
</script>
</body>
</html>
