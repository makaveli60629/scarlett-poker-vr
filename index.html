<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POKER VR - 2.1.14 NAV MENU</title>
    <style> body { margin: 0; background-color: #000; overflow: hidden; } </style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

        let stats = JSON.parse(localStorage.getItem('poker_master_save')) || { chips: 5000, rank: "ROOKIE" };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x01020a);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const cameraRig = new THREE.Group();
        cameraRig.position.set(0, 0, 20); 
        cameraRig.add(camera);
        scene.add(cameraRig);
        scene.add(new THREE.AmbientLight(0xffffff, 1.0), new THREE.DirectionalLight(0xffffff, 2));

        const texLoader = new THREE.TextureLoader();
        const carpet = texLoader.load('assets/textures/lobby_carpet.jpg');
        [carpet].forEach(t => { t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(20, 20); });

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({map: carpet}));
        floor.rotation.x = -Math.PI/2; scene.add(floor);

        // 1. NAVIGATION HALOS
        function createHalo(x, z, color, label) {
            const g = new THREE.Group();
            const ring = new THREE.Mesh(new THREE.TorusGeometry(2.5, 0.1, 16, 100), new THREE.MeshBasicMaterial({color: color, transparent: true, opacity: 0.6}));
            ring.rotation.x = Math.PI/2;
            const beam = new THREE.Mesh(new THREE.CylinderGeometry(2.5, 2.5, 0.2, 32, 1, true), new THREE.MeshBasicMaterial({color: color, transparent: true, opacity: 0.2}));
            g.add(ring, beam); g.position.set(x, 0.1, z); scene.add(g);
            return g;
        }
        const pokerHalo = createHalo(0, 5, 0xff00ff); // Magenta for Poker
        const storeHalo = createHalo(0, -40, 0x00ff00); // Green for Store

        // 2. OCULUS WRIST MENU (3 BUTTONS)
        const controllerL = renderer.xr.getController(1);
        const controllerR = renderer.xr.getController(0);
        
        const menuRoot = new THREE.Group();
        menuRoot.visible = false;
        menuRoot.position.set(0, 0.1, 0); menuRoot.rotation.x = -Math.PI/2;
        controllerL.add(menuRoot);

        const menuBG = new THREE.Mesh(new THREE.PlaneGeometry(0.3, 0.4), new THREE.MeshBasicMaterial({color: 0x000000, transparent: true, opacity: 0.9}));
        menuRoot.add(menuBG);

        function createMenuBtn(text, y, color) {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#" + color.toString(16).padStart(6, '0'); ctx.fillRect(0,0,256,64);
            ctx.fillStyle = "white"; ctx.font = "bold 30px Arial"; ctx.textAlign = "center"; ctx.fillText(text, 128, 42);
            const btn = new THREE.Mesh(new THREE.PlaneGeometry(0.25, 0.08), new THREE.MeshBasicMaterial({map: new THREE.CanvasTexture(canvas)}));
            btn.position.y = y; btn.userData = { action: text };
            menuRoot.add(btn);
            return btn;
        }

        const btnLobby = createMenuBtn("LOBBY", 0.12, 0x444444);
        const btnPoker = createMenuBtn("POKER", 0, 0xff00ff);
        const btnStore = createMenuBtn("STORE", -0.12, 0x00ff00);

        // 3. CONTROLS & RAYCASTERS
        const laserL = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]), new THREE.LineBasicMaterial({color: 0x00ffff}));
        laserL.scale.z = 100; controllerL.add(laserL);
        
        const pointerR = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]), new THREE.LineBasicMaterial({color: 0xffffff}));
        pointerR.scale.z = 5; controllerR.add(pointerR);

        cameraRig.add(controllerL, controllerR);
        const rayL = new THREE.Raycaster();
        const rayR = new THREE.Raycaster();
        let cooldown = false;

        renderer.setAnimationLoop(() => {
            pokerHalo.rotation.y += 0.01; storeHalo.rotation.y += 0.01;
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    const b = source.gamepad.buttons;
                    if (source.handedness === 'left') {
                        // Movement (Trigger)
                        rayL.ray.origin.setFromMatrixPosition(controllerL.matrixWorld);
                        const m = new THREE.Matrix4().extractRotation(controllerL.matrixWorld);
                        rayL.ray.direction.set(0, 0, -1).applyMatrix4(m);
                        const hits = rayL.intersectObject(floor);
                        if (hits.length > 0 && b[0].pressed) cameraRig.position.copy(hits[0].point);
                        
                        // Toggle Menu (Y Button)
                        if ((b[4].pressed || b[5].pressed) && !cooldown) {
                            menuRoot.visible = !menuRoot.visible; cooldown = true; setTimeout(() => cooldown = false, 500);
                        }
                    }
                    if (source.handedness === 'right' && menuRoot.visible) {
                        // Menu Interaction
                        rayR.ray.origin.setFromMatrixPosition(controllerR.matrixWorld);
                        const mR = new THREE.Matrix4().extractRotation(controllerR.matrixWorld);
                        rayR.ray.direction.set(0, 0, -1).applyMatrix4(mR);
                        const menuHits = rayR.intersectObjects(menuRoot.children);
                        if (menuHits.length > 0) {
                            menuHits[0].object.scale.set(1.1, 1.1, 1);
                            if (b[0].pressed && !cooldown) {
                                const action = menuHits[0].object.userData.action;
                                if (action === "LOBBY") cameraRig.position.set(0, 0, 20);
                                if (action === "POKER") cameraRig.position.set(0, 0, 10);
                                if (action === "STORE") cameraRig.position.set(0, 0, -40);
                                cooldown = true; setTimeout(() => cooldown = false, 500);
                            }
                        } else {
                            [btnLobby, btnPoker, btnStore].forEach(btn => btn.scale.set(1, 1, 1));
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
