<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POKER VR MASTER - 1.9.8</title>
    <style> body { margin: 0; background-color: #000; overflow: hidden; } </style>
</head>
<body>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

        // 1. DATA & STATS
        let stats = JSON.parse(localStorage.getItem('poker_master_save')) || { 
            chips: 500, rank: "ROOKIE", name: "Player 1" 
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const cameraRig = new THREE.Group();
        cameraRig.position.set(0, 0, 15);
        cameraRig.add(camera);
        scene.add(cameraRig);

        scene.add(new THREE.PointLight(0xffffff, 20, 50, 2), new THREE.AmbientLight(0xffffff, 0.4));

        // 2. HOLOGRAPHIC LEADERBOARD (Floating over table)
        const hudCanvas = document.createElement('canvas');
        hudCanvas.width = 512; hudCanvas.height = 256;
        const hCtx = hudCanvas.getContext('2d');
        const hudTex = new THREE.CanvasTexture(hudCanvas);
        const hudMesh = new THREE.Mesh(
            new THREE.PlaneGeometry(4, 2), 
            new THREE.MeshBasicMaterial({ map: hudTex, transparent: true, side: THREE.DoubleSide })
        );
        hudMesh.position.set(0, 5, -2); // Floats 5 meters up
        scene.add(hudMesh);

        function updateHUD() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            hCtx.clearRect(0, 0, 512, 256);
            // Background Glow
            hCtx.fillStyle = "rgba(0, 255, 255, 0.1)";
            hCtx.fillRect(0, 0, 512, 256);
            hCtx.strokeStyle = "#00ffff"; hCtx.lineWidth = 8;
            hCtx.strokeRect(10, 10, 492, 236);
            
            // Text
            hCtx.fillStyle = "#00ffff"; hCtx.font = "bold 40px Arial";
            hCtx.fillText("PLAYER STATS", 140, 60);
            hCtx.fillStyle = "#ffffff"; hCtx.font = "32px Arial";
            hCtx.fillText(`RANK: ${stats.rank}`, 50, 120);
            hCtx.fillText(`BANK: $${stats.chips}`, 50, 170);
            hCtx.fillStyle = "#00ffff";
            hCtx.fillText(`TIME: ${timeStr}`, 300, 210);
            hudTex.needsUpdate = true;
        }

        // 3. ENVIRONMENT (70m Hall)
        const texLoader = new THREE.TextureLoader();
        const path = 'assets/textures/';
        const floorTex = texLoader.load(path + 'lobby_carpet.jpg');
        floorTex.wrapS = floorTex.wrapT = THREE.RepeatWrapping; floorTex.repeat.set(20,20);
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(70, 70), new THREE.MeshStandardMaterial({map: floorTex}));
        floor.rotation.x = -Math.PI/2; scene.add(floor);

        const table = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 0.6, 32), new THREE.MeshStandardMaterial({ color: 0x0a3d0a }));
        table.position.set(0, 0.8, 0); scene.add(table);

        // 4. LEFT-HAND MASTER LOCOMOTION
        const controllerL = renderer.xr.getController(1);
        const laser = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]), new THREE.LineBasicMaterial({color: 0x00ffcc}));
        laser.scale.z = 100; controllerL.add(laser); cameraRig.add(controllerL);

        const marker = new THREE.Mesh(new THREE.RingGeometry(0.4, 0.5, 32), new THREE.MeshBasicMaterial({ color: 0x00ffcc }));
        marker.rotation.x = -Math.PI/2; scene.add(marker);

        let turnCooldown = false;
        const raycaster = new THREE.Raycaster();

        renderer.setAnimationLoop(() => {
            updateHUD(); // Keep time and chips updated
            
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    const b = source.gamepad.buttons;
                    const a = source.gamepad.axes;

                    if (source.handedness === 'left') {
                        // Teleport Aim
                        const m = new THREE.Matrix4().extractRotation(controllerL.matrixWorld);
                        raycaster.ray.origin.setFromMatrixPosition(controllerL.matrixWorld);
                        raycaster.ray.direction.set(0, 0, -1).applyMatrix4(m);
                        const hits = raycaster.intersectObject(floor);
                        if (hits.length > 0) {
                            marker.position.copy(hits[0].point); marker.visible = true;
                            if (b[0].pressed) cameraRig.position.copy(marker.position);
                        }
                        // Stick Turn
                        if (!turnCooldown && Math.abs(a[2]) > 0.8) {
                            cameraRig.rotation.y -= Math.sign(a[2]) * (Math.PI / 4);
                            turnCooldown = true; setTimeout(() => turnCooldown = false, 300);
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
