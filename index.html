<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scarlett Empire - VR Movement Fix</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; }
        #vr-ui { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.8); padding: 10px; z-index: 10; border: 1px solid #0f0; pointer-events: none; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="vr-ui">
        <b>DIAGNOSTICS</b><br>
        XR: <span id="xr-stat">OFFLINE</span><br>
        HANDS: <span id="hand-stat">WAITING</span><br>
        POS: <span id="pos-stat">0,0,0</span>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

        const S = {
            scene: new THREE.Scene(),
            camera: new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000),
            renderer: new THREE.WebGLRenderer({ antialias: true }),
            player: new THREE.Group(), // This is the 'Rig' we move
            handFactory: new XRHandModelFactory(),
            floors: [],
            raycaster: new THREE.Raycaster(),
            down: new THREE.Vector3(0, -1, 0)
        };

        async function init() {
            S.renderer.setSize(window.innerWidth, window.innerHeight);
            S.renderer.xr.enabled = true;
            document.body.appendChild(S.renderer.domElement);
            document.body.appendChild(VRButton.createButton(S.renderer));

            S.scene.add(S.player);
            S.player.add(S.camera);

            // 1. INITIAL SPAWN (VIP Room)
            S.player.position.set(14, 0, 6); 

            // 2. THE FORCE-CALIBRATION FIX
            S.renderer.xr.addEventListener('sessionstart', () => {
                document.getElementById('xr-stat').innerText = "VR ACTIVE";
                
                // Wait 1 second for the headset to finish its internal reset
                setTimeout(() => {
                    // Force the player to look at the center of the Poker Pit (0, -1.6, 0)
                    const target = new THREE.Vector3(0, -1.6, 0);
                    S.player.lookAt(target.x, S.player.position.y, target.z);
                    console.log("Diagnostics: View snapped to table.");
                }, 1000);
            });

            setupHands();
            buildWorld();
            S.renderer.setAnimationLoop(tick);
        }

        function setupHands() {
            for (let i = 0; i < 2; i++) {
                const hand = S.renderer.xr.getHand(i);
                hand.add(S.handFactory.createHandModel(hand, "mesh"));
                S.player.add(hand);

                // Add controller support for Android devices without hand-tracking
                const controller = S.renderer.xr.getController(i);
                S.player.add(controller);

                hand.addEventListener('connected', () => {
                    document.getElementById('hand-stat').innerText = "CONNECTED âœ…";
                });
            }
        }

        function buildWorld() {
            const mat = new THREE.MeshStandardMaterial({ color: 0x0b0d14 });
            
            // Top Floor
            const top = new THREE.Mesh(new THREE.RingGeometry(9, 25, 64), mat);
            top.rotation.x = -Math.PI/2;
            S.scene.add(top); S.floors.push(top);

            // Pit Floor
            const pit = new THREE.Mesh(new THREE.CircleGeometry(6.4, 64), mat);
            pit.position.y = -1.6; pit.rotation.x = -Math.PI/2;
            S.scene.add(pit); S.floors.push(pit);

            // Ramp (The part you walk down)
            const ramp = new THREE.Mesh(new THREE.CylinderGeometry(6.4, 9, 1.6, 64, 1, true), mat);
            ramp.position.y = -0.8;
            S.scene.add(ramp); S.floors.push(ramp);

            // Lighting
            S.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const p = new THREE.PointLight(0x7fe7ff, 2, 20); p.position.set(0,5,0); S.scene.add(p);
        }

        function tick() {
            // GRAVITY & MOVEMENT LOGIC
            // We cast a ray down from your head to find the floor
            S.raycaster.set(S.player.position, S.down);
            const hit = S.raycaster.intersectObjects(S.floors);
            
            if (hit.length > 0) {
                // Smoothly adjust your height as you walk down the ramp
                S.player.position.y = THREE.MathUtils.lerp(S.player.position.y, hit[0].point.y, 0.1);
            }

            document.getElementById('pos-stat').innerText = 
                `${Math.round(S.player.position.x)}, ${Math.round(S.player.position.y)}, ${Math.round(S.player.position.z)}`;

            S.renderer.render(S.scene, S.camera);
        }

        init();
    </script>
</body>
</html>
