<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Brick Club VR - DNA Fixed</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #overlay {
            position: absolute; width: 100%; height: 100%; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            background: #000; z-index: 100; color: #ffd700;
        }
        button {
            padding: 20px 60px; font-size: 24px; background: #8B0000;
            color: white; border: 2px solid #ffd700; border-radius: 50px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>BRICK CLUB CASINO</h1>
        <button id="start-btn">ENTER VR</button>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { VRButton } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/VRButton.js';
        
        import { initEngine } from './core/engine.js';
        import { buildLobby } from './world/lobby.js';
        import { setupOculus, updateLocomotion } from './core/controls.js';
        import { initAvatarStore } from './features/avatar.js';
        import { initPokerGame, checkTableProximity } from './features/poker-logic.js';

        let scene, camera, renderer, userRig;
        const tablePos = new THREE.Vector3(0, 0.8, -5);

        async function start() {
            // Get engine components and EXPLICITLY assign userRig
            const engine = initEngine();
            scene = engine.scene;
            camera = engine.camera;
            renderer = engine.renderer;
            userRig = engine.userRig; // Crucial fix: capturing the rig from the engine

            buildLobby(scene);
            initAvatarStore(scene, camera);
            initPokerGame(scene);
            setupOculus(renderer, scene, userRig);

            renderer.setAnimationLoop(() => {
                // Pass BOTH renderer and the specific userRig to the movement logic
                updateLocomotion(renderer, userRig);
                checkTableProximity(userRig, tablePos, camera);
                renderer.render(scene, camera);
            });
        }

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            start();
        };
    </script>
</body>
</html>
