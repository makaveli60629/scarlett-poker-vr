import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
import { VRButton } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/VRButton.js';
import { XRControllerModelFactory } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/XRControllerModelFactory.js';

let scene, camera, renderer, controllers = [];
let playerSatDown = false;

// Assets Path Constant (Ready for 1.4)
const TEXTURE_PATH = 'assets/textures/';

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505); // Dark, high-end atmosphere

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 5);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);
    document.body.appendChild(VRButton.createButton(renderer));

    // 1. LIGHTING
    const mainLight = new THREE.PointLight(0xffffff, 1, 100);
    mainLight.position.set(0, 5, 0);
    scene.add(mainLight);
    scene.add(new THREE.AmbientLight(0x404040, 0.5));

    // 2. THE BIG LOBBY (Removed Arches/Doorways)
    const lobbySize = 20;
    const lobbyGeom = new THREE.BoxGeometry(lobbySize, 8, lobbySize);
    const lobbyMat = new THREE.MeshStandardMaterial({ 
        color: 0x222222, 
        side: THREE.BackSide 
    });
    const lobby = new THREE.Mesh(lobbyGeom, lobbyMat);
    scene.add(lobby);

    // Add Top Trim (Matching Bottom Trim)
    createWallTrim(lobbySize, 8);
    // Add Pillars at the 4 corners
    createCornerPillars(lobbySize, 8);

    // 3. VR CONTROLLERS (Oculus Mapping)
    setupVR();

    // 4. THE POKER TABLE & HOVER MENU
    createPokerTable();
    createHoveringMenu();

    // 5. "PLAY GAME" AUTOMATIC ZONE
    createPlayZone();

    window.addEventListener('resize', onWindowResize, false);
}

function createWallTrim(size, height) {
    const trimGeom = new THREE.BoxGeometry(size, 0.2, size);
    const trimMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
    
    const topTrim = new THREE.Mesh(trimGeom, trimMat);
    topTrim.position.y = height / 2 - 0.1;
    scene.add(topTrim);

    const bottomTrim = new THREE.Mesh(trimGeom, trimMat);
    bottomTrim.position.y = -height / 2 + 0.1;
    scene.add(bottomTrim);
}

function createCornerPillars(size, height) {
    const pillarGeom = new THREE.CylinderGeometry(0.3, 0.3, height, 32);
    const pillarMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
    const offset = size / 2 - 0.3;

    const positions = [
        [offset, 0, offset], [offset, 0, -offset],
        [-offset, 0, offset], [-offset, 0, -offset]
    ];

    positions.forEach(pos => {
        const pillar = new THREE.Mesh(pillarGeom, pillarMat);
        pillar.position.set(...pos);
        scene.add(pillar);
    });
}

function createHoveringMenu() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 256; canvas.height = 128;
    ctx.fillStyle = 'white';
    ctx.font = '24px Arial';
    ctx.fillText('LOBBY MENU', 50, 60);

    const tex = new THREE.CanvasTexture(canvas);
    const plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 0.5),
        new THREE.MeshBasicMaterial({ map: tex, transparent: true })
    );
    plane.position.set(-2, 2, -2);
    scene.add(plane);
}

function createPokerTable() {
    const table = new THREE.Mesh(
        new THREE.CylinderGeometry(1.5, 1.5, 0.1, 32),
        new THREE.MeshStandardMaterial({ color: 0x076324 })
    );
    table.position.set(0, 0.8, -2);
    scene.add(table);
}

function createPlayZone() {
    const zone = new THREE.Mesh(
        new THREE.CircleGeometry(0.8, 32),
        new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.2 })
    );
    zone.rotation.x = -Math.PI / 2;
    zone.position.set(0, 0.05, -2);
    zone.name = "PlayZone";
    scene.add(zone);
}

function setupVR() {
    const modelFactory = new XRControllerModelFactory();
    for (let i = 0; i < 2; i++) {
        const controller = renderer.xr.getController(i);
        scene.add(controller);
        const grip = renderer.xr.getControllerGrip(i);
        grip.add(modelFactory.createControllerModel(grip));
        scene.add(grip);
        controllers.push(controller);
    }
}

function checkAutoSit() {
    const dist = camera.position.distanceTo(new THREE.Vector3(0, 1.6, -2));
    if (dist < 1.0 && !playerSatDown) {
        playerSatDown = true;
        triggerWinNotification("PLAYER SEATED");
    }
}

function triggerWinNotification(msg) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 512; canvas.height = 128;
    ctx.fillStyle = 'yellow';
    ctx.font = 'bold 50px Arial';
    ctx.fillText(msg, 100, 70);

    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    sprite.position.set(0, 2.5, -2);
    sprite.scale.set(2, 0.5, 1);
    scene.add(sprite);

    // Highlight player
    const ring = new THREE.Mesh(
        new THREE.RingGeometry(0.7, 0.8, 32),
        new THREE.MeshBasicMaterial({ color: 0xffff00, side: THREE.DoubleSide })
    );
    ring.rotation.x = Math.PI / 2;
    ring.position.set(0, 0.1, -2);
    scene.add(ring);

    setTimeout(() => {
        scene.remove(sprite);
        scene.remove(ring);
    }, 10000);
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    renderer.setAnimationLoop(() => {
        checkAutoSit();
        renderer.render(scene, camera);
    });
}
