<script type="module">
    import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
    import { VRButton } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/webxr/VRButton.js';
    import { initEngine } from './core/engine.js';
    import { buildPermanentLobby } from './world/lobby.js';
    import { buildStoreRoom } from './world/store-room.js';
    import { updateLocomotion } from './core/controls.js';

    let scene, camera, renderer, userRig, portals = [];
    let currentRoom = 'LOBBY';

    async function start() {
        const engine = initEngine();
        scene = engine.scene; renderer = engine.renderer; userRig = engine.userRig;
        
        document.body.appendChild(VRButton.createButton(renderer));
        loadLevel('LOBBY');

        renderer.setAnimationLoop(() => {
            updateLocomotion(renderer, userRig);
            
            // 1. SOLID WALL LOGIC (Keep player inside 12x20 area)
            if (currentRoom === 'LOBBY') {
                userRig.position.x = Math.max(-5.5, Math.min(5.5, userRig.position.x));
                userRig.position.z = Math.max(-9.5, Math.min(9.5, userRig.position.z));
            } else {
                userRig.position.x = Math.max(-3.5, Math.min(3.5, userRig.position.x));
                userRig.position.z = Math.max(-3.5, Math.min(3.5, userRig.position.z));
            }

            // 2. PORTAL TELEPORT LOGIC
            portals.forEach(p => {
                const dist = userRig.position.distanceTo(p.position);
                if (dist < 0.8) { // If you are within 1 meter of the circle
                    if (p.userData.dest && p.userData.dest !== currentRoom) {
                        loadLevel(p.userData.dest);
                    }
                }
            });

            renderer.render(scene, engine.camera);
        });
        document.getElementById('overlay').style.display = 'none';
    }

    function loadLevel(level) {
        // Clear old level
        while(scene.children.length > 0){ 
            if(scene.children[0].type === 'Group') scene.remove(scene.children[0]);
            else break; 
        }
        
        if (level === 'LOBBY') {
            const data = buildPermanentLobby(scene);
            portals = data.portals;
            currentRoom = 'LOBBY';
            userRig.position.set(0, 1.6, 5); // Reset position in lobby
        } else if (level === 'STORE') {
            const data = buildStoreRoom(scene);
            portals = data.portals;
            currentRoom = 'STORE';
            userRig.position.set(0, 1.6, 2); // Reset position in store
        }
    }

    document.getElementById('start-btn').onclick = start;
</script>
