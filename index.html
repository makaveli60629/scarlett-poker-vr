<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Poker - GitHub Permanent v1.4.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #vr-button { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); }
    </style>
</head>
<body>
<script>
    // --- MEMORY BANK: PERSISTENT VARIABLES ---
    let scene, camera, renderer, userGroup;
    let handLeft, handRight;
    let menuGroup, leaderboard;
    let isMenuOpen = false;
    let lastPinchTime = 0;

    // --- INITIALIZATION ---
    function init() {
        // 1. Create Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a); // Dark grey, not black, to confirm loading

        // 2. Camera & User Group (The 'Rig')
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        userGroup = new THREE.Group();
        userGroup.add(camera);
        scene.add(userGroup);

        // SAFE SPAWN: Position user at origin, looking toward the table
        userGroup.position.set(0, 1.6, 3); 

        // 3. Renderer Setup
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // 4. Lights (Crucial to see objects)
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 0.8);
        directional.position.set(0, 10, 5);
        scene.add(directional);

        // 5. Build the World
        setupEnvironment();
        setupHands();
        createVRMenu();
        createLeaderboard();

        // 6. Enter VR Button
        importVRButton();

        // 7. Start Loop
        animate();
    }

    function importVRButton() {
        // Manually creating the VR Button logic to ensure no loading errors
        const button = document.createElement('button');
        button.id = "vr-button";
        button.innerHTML = "ENTER VR";
        button.style.padding = "12px 24px";
        button.onclick = () => {
            navigator.xr.requestSession('immersive-vr', {
                optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking']
            }).then(session => renderer.xr.setSession(session));
        };
        document.body.appendChild(button);
    }

    // --- WORLD ELEMENTS ---
    function setupEnvironment() {
        // Floor
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(50, 50),
            new THREE.MeshStandardMaterial({ color: 0x151515 })
        );
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // POKER TABLE (Moved to -5 to be clearly visible from spawn)
        const table = new THREE.Group();
        table.position.set(0, 0, -5);
        
        const top = new THREE.Mesh(
            new THREE.CylinderGeometry(2, 2, 0.2, 32),
            new THREE.MeshStandardMaterial({ color: 0x004400 })
        );
        top.position.y = 1;
        table.add(top);

        // Chairs (Aligned)
        for(let i=0; i<6; i++) {
            const angle = (i/6) * Math.PI * 2;
            const chair = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 0.5, 0.5),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            chair.position.set(Math.cos(angle)*2.5, 0.25, Math.sin(angle)*2.5);
            chair.lookAt(0, 0.25, 0);
            table.add(chair);
        }
        scene.add(table);

        // THE STORE (Off to the right)
        const store = new THREE.Mesh(
            new THREE.BoxGeometry(3, 2, 0.5),
            new THREE.MeshStandardMaterial({ color: 0x3d2b1f })
        );
        store.position.set(6, 1, -2);
        scene.add(store);
    }

    function createLeaderboard() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 512; canvas.height = 256;
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,512,256);
        ctx.fillStyle = 'gold'; ctx.font = '40px Arial';
        ctx.fillText('LEADERBOARD', 120, 60);
        ctx.fillStyle = 'white'; ctx.font = '24px Arial';
        ctx.fillText('1. YOU: $1,000,000', 50, 120);

        leaderboard = new THREE.Mesh(
            new THREE.PlaneGeometry(3, 1.5),
            new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas) })
        );
        leaderboard.position.set(0, 3, -8);
        scene.add(leaderboard);
    }

    // --- HANDS & INTERACTION ---
    function setupHands() {
        handLeft = renderer.xr.getHand(0);
        handRight = renderer.xr.getHand(1);

        // HAND TRACKING ONLY (No Controllers)
        handLeft.addEventListener('pinchstart', () => {
            const now = Date.now();
            if(now - lastPinchTime > 500) {
                isMenuOpen = !isMenuOpen;
                menuGroup.visible = isMenuOpen;
                if(isMenuOpen) {
                    const pos = new THREE.Vector3();
                    handLeft.getWorldPosition(pos);
                    menuGroup.position.set(pos.x, pos.y + 0.1, pos.z - 0.2);
                    menuGroup.lookAt(camera.position);
                }
                lastPinchTime = now;
            }
        });

        scene.add(handLeft);
        scene.add(handRight);
    }

    function createVRMenu() {
        menuGroup = new THREE.Group();
        const locations = [
            { name: 'Lobby', pos: [0, 1.6, 3] },
            { name: 'Poker', pos: [0, 1.6, -2] },
            { name: 'Store', pos: [5, 1.6, -1] }
        ];

        locations.forEach((loc, i) => {
            const btn = new THREE.Mesh(
                new THREE.BoxGeometry(0.2, 0.08, 0.02),
                new THREE.MeshStandardMaterial({ color: 0x0000ff })
            );
            btn.position.y = 0.2 - (i * 0.1);
            btn.userData = { target: loc.pos };
            menuGroup.add(btn);
        });

        menuGroup.visible = false;
        scene.add(menuGroup);
    }

    function checkInteraction() {
        if (!isMenuOpen) return;
        
        // Right Hand Index Tip (Joint 9)
        const tip = handRight.joints ? handRight.joints['index-finger-tip'] : null;
        if (!tip || !tip.visible) return;

        menuGroup.children.forEach(btn => {
            const btnPos = new THREE.Vector3();
            btn.getWorldPosition(btnPos);
            if (tip.position.distanceTo(btnPos) < 0.04) {
                userGroup.position.set(...btn.userData.target);
                isMenuOpen = false;
                menuGroup.visible = false;
            }
        });
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            checkInteraction();
            renderer.render(scene, camera);
        });
    }

    window.onload = init; // Ensures script runs after page loads
</script>
</body>
</html>
