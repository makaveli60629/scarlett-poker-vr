<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POKER VR MASTER - 1.9.4</title>
    <style> 
        body { margin: 0; background-color: #111; overflow: hidden; font-family: Arial, sans-serif; }
        #loading-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; z-index: 10; }
    </style>
</head>
<body>
    <div id="loading-ui">INITIALIZING POKER VR...</div>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/VRButton.js';

        // 1. DATA & STATS
        let stats = JSON.parse(localStorage.getItem('poker_master_save')) || { chips: 500, inventory: [], lastClaim: 0 };
        const save = () => localStorage.setItem('poker_master_save', JSON.stringify(stats));

        // 2. SCENE SETUP
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505); // Very dark grey instead of pure black
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const cameraRig = new THREE.Group();
        cameraRig.position.set(0, 0, 10);
        cameraRig.add(camera);
        scene.add(cameraRig);

        // Lights
        const ambient = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
        scene.add(ambient);

        // 3. TEXTURES (With Error Handling to prevent Black Screen)
        const texLoader = new THREE.TextureLoader();
        const loadTex = (file) => {
            return texLoader.load('assets/textures/' + file, 
                () => { console.log(file + ' loaded'); },
                undefined,
                () => { console.warn('Failed to load ' + file + ' using fallback.'); }
            );
        };

        const tex = {
            brick: loadTex('brickwall.jpg'),
            carpet: loadTex('lobby_carpet.jpg'),
            felt: loadTex('table_felt_green.jpg'),
            logo: loadTex('brand_logo.jpg')
        };

        // 4. ENVIRONMENT MESHES
        const lobbySize = 70;
        const floorGeo = new THREE.PlaneGeometry(lobbySize, lobbySize);
        const floorMat = new THREE.MeshStandardMaterial({ map: tex.carpet, color: 0x444444 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);

        // Walls
        const wallMat = new THREE.MeshStandardMaterial({ map: tex.brick, color: 0x666666 });
        for(let i=0; i<4; i++) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(lobbySize, 15, 1), wallMat);
            const angle = (Math.PI/2) * i;
            wall.position.set(Math.sin(angle)*(lobbySize/2), 7.5, Math.cos(angle)*(lobbySize/2));
            wall.rotation.y = angle;
            scene.add(wall);
        }

        // Table
        const table = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 0.6, 32), new THREE.MeshStandardMaterial({ map: tex.felt }));
        table.position.set(0, 0.8, 0);
        scene.add(table);

        // 5. CONTROLS (Left Navigation)
        const controllerL = renderer.xr.getController(1);
        cameraRig.add(controllerL);
        const controllerR = renderer.xr.getController(0);
        cameraRig.add(controllerR);

        const marker = new THREE.Mesh(new THREE.RingGeometry(0.4, 0.5, 32), new THREE.MeshBasicMaterial({ color: 0x00ffcc }));
        marker.rotation.x = -Math.PI/2;
        scene.add(marker);

        const raycaster = new THREE.Raycaster();
        let turnCooldown = false;

        // Hide loading text once rendering starts
        renderer.setAnimationLoop(() => {
            const loaderUI = document.getElementById('loading-ui');
            if(loaderUI) loaderUI.style.display = 'none';

            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    const b = source.gamepad.buttons;
                    const axes = source.gamepad.axes;

                    if (source.handedness === 'left') {
                        const m = new THREE.Matrix4().extractRotation(controllerL.matrixWorld);
                        raycaster.ray.origin.setFromMatrixPosition(controllerL.matrixWorld);
                        raycaster.ray.direction.set(0, 0, -1).applyMatrix4(m);
                        const hits = raycaster.intersectObject(floor);
                        if (hits.length > 0) {
                            marker.position.copy(hits[0].point);
                            marker.visible = true;
                            if (b[0].pressed) cameraRig.position.set(marker.position.x, 0, marker.position.z);
                        }
                    }

                    if (source.handedness === 'right' && !turnCooldown) {
                        if (Math.abs(axes[2]) > 0.8) {
                            cameraRig.rotation.y -= Math.sign(axes[2]) * (Math.PI/4);
                            turnCooldown = true;
                            setTimeout(() => turnCooldown = false, 300);
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
