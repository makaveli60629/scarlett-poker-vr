<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Poker - Permanent Update 1.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/webxr/VRButton.js"></script>
    <style>body { margin: 0; overflow: hidden; background-color: #000; }</style>
</head>
<body>
<script>
    // --- PERSISTENT MEMORY & CONFIG ---
    let scene, camera, renderer, userGroup;
    let handLeft, handRight;
    let menuVisible = false, menuGroup;
    let lastPinchTime = 0;
    const TEXTURE_PATH = 'assets/textures/';

    // --- INITIALIZATION ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);

        // Player Group (To prevent spawning inside objects)
        userGroup = new THREE.Group();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        userGroup.add(camera);
        scene.add(userGroup);
        
        // Spawn Location (Safe Zone)
        userGroup.position.set(0, 0, 2); 

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        setupLights();
        setupEnvironment();
        setupHands();
        createHoveringLeaderboard();
        createVRMenu();
        
        animate();
    }

    function setupLights() {
        const ambient = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambient);
        const spot = new THREE.SpotLight(0xffffff, 0.8);
        spot.position.set(0, 10, 0);
        scene.add(spot);
    }

    // --- WORLD BUILDING (Lobby, Store, Poker Room) ---
    function setupEnvironment() {
        // Floor - Texture Placeholder for Update 1.4
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // --- POKER ROOM (Centered at 0, 0, -6 for safe distance) ---
        const tableGroup = new THREE.Group();
        tableGroup.position.set(0, 0, -6);

        const tableTop = new THREE.Mesh(
            new THREE.CylinderGeometry(2.5, 2.5, 0.2, 64),
            new THREE.MeshStandardMaterial({ color: 0x0a5c2f }) // Green felt
        );
        tableTop.position.y = 1;
        tableGroup.add(tableTop);

        // Perfectly Aligned Seats (Update 1.3/1.4 Polish)
        for(let i=0; i<6; i++) {
            const angle = (i/6) * Math.PI * 2;
            const chair = new THREE.Group();
            
            const seat = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.1, 0.6),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            const back = new THREE.Mesh(
                new THREE.BoxGeometry(0.6, 0.8, 0.1),
                new THREE.MeshStandardMaterial({ color: 0x222222 })
            );
            back.position.set(0, 0.4, 0.3);
            chair.add(seat, back);
            
            chair.position.set(Math.cos(angle)*3.2, 0.5, Math.sin(angle)*3.2);
            chair.lookAt(0, 0.5, -6);
            tableGroup.add(chair);
        }
        scene.add(tableGroup);

        // --- THE STORE ---
        const store = new THREE.Group();
        store.position.set(10, 0, 0);
        const shelf = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 5), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
        shelf.position.y = 1.5;
        store.add(shelf);
        scene.add(store);
    }

    // --- HOVERING LEADERSHIP BOARD ---
    function createHoveringLeaderboard() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 512; canvas.height = 256;
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,512,256);
        ctx.strokeStyle = '#gold'; ctx.lineWidth = 10; ctx.strokeRect(0,0,512,256);
        ctx.fillStyle = 'gold'; ctx.font = 'bold 40px Arial'; ctx.fillText('LEADERBOARD', 120, 60);
        ctx.fillStyle = 'white'; ctx.font = '30px Arial';
        ctx.fillText('1. Player_1: $2.5M', 50, 130);
        ctx.fillText('2. HighRoller: $1.8M', 50, 180);

        const board = new THREE.Mesh(
            new THREE.PlaneGeometry(4, 2),
            new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true })
        );
        board.position.set(0, 4, -9); // Floating high in the Poker Room
        scene.add(board);
    }

    // --- HANDS & INTERACTION ---
    function setupHands() {
        handLeft = renderer.xr.getHand(0);
        handRight = renderer.xr.getHand(1);

        // Hand Models (Ensuring Hands Only)
        const controllerModelFactory = { /* Standard VR Hand Factory */ };
        
        // Left Pinch = Menu Toggle
        handLeft.addEventListener('pinchstart', () => {
            const now = Date.now();
            if(now - lastPinchTime > 500) {
                menuVisible = !menuVisible;
                menuGroup.visible = menuVisible;
                if(menuVisible) {
                    const pos = new THREE.Vector3();
                    handLeft.getWorldPosition(pos);
                    menuGroup.position.set(pos.x, pos.y + 0.1, pos.z - 0.2);
                    menuGroup.lookAt(camera.position);
                }
                lastPinchTime = now;
            }
        });

        scene.add(handLeft);
        scene.add(handRight);
    }

    // --- MENU & TELEPORTER BUTTONS ---
    function createVRMenu() {
        menuGroup = new THREE.Group();
        const locations = [
            { name: 'Lobby', target: [0, 0, 2] },
            { name: 'Poker Room', target: [0, 0, -3] },
            { name: 'Store', target: [8, 0, 0] }
        ];

        locations.forEach((loc, i) => {
            const btnGeo = new THREE.BoxGeometry(0.3, 0.1, 0.05);
            const btnMat = new THREE.MeshStandardMaterial({ color: 0x0000ff });
            const btn = new THREE.Mesh(btnGeo, btnMat);
            btn.position.y = 0.2 - (i * 0.15);
            btn.userData = { target: loc.target };
            menuGroup.add(btn);
        });

        menuGroup.visible = false;
        scene.add(menuGroup);
    }

    function checkMenuCollision() {
        if (!menuVisible) return;
        
        // Use Right Index Tip to press
        const indexTip = handRight.joints ? handRight.joints['index-finger-tip'] : null;
        if (!indexTip || !indexTip.visible) return;

        menuGroup.children.forEach(btn => {
            const btnWorldPos = new THREE.Vector3();
            btn.getWorldPosition(btnWorldPos);
            if (indexTip.position.distanceTo(btnWorldPos) < 0.04) {
                teleport(btn.userData.target);
            }
        });
    }

    function teleport(pos) {
        userGroup.position.set(pos[0], pos[1], pos[2]);
        menuVisible = false;
        menuGroup.visible = false;
    }

    function animate() {
        renderer.setAnimationLoop(() => {
            checkMenuCollision();
            renderer.render(scene, camera);
        });
    }

    init();
</script>
</body>
</html>
