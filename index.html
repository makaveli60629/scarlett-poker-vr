<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poker VR 1.3 - Master Build</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        /* Winner Pop-up (10-second rule) */
        #win-notification {
            position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); border: 3px solid gold;
            color: white; padding: 20px; border-radius: 15px; display: none;
            text-align: center; z-index: 1000; font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="win-notification">
        <h1 id="winner-name">WINNER</h1>
        <p id="winner-hand">HAND</p>
    </div>

    <script type="importmap">
        { "imports": { 
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" 
        } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        // --- 1. PHYSICS ENGINE (Capital P) ---
        class Physics {
            constructor() { this.colliders = []; }
            add(mesh) {
                const box = new THREE.Box3().setFromObject(mesh);
                this.colliders.push(box);
            }
            check(pos) {
                const playerSphere = new THREE.Sphere(pos, 0.5);
                for(let wall of this.colliders) {
                    if(wall.intersectsSphere(playerSphere)) return true;
                }
                return false;
            }
        }
        const P = new Physics();

        // --- 2. SCENE & VR PLAYER RIG ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const playerRig = new THREE.Group();
        playerRig.add(camera);
        scene.add(playerRig);
        playerRig.position.set(0, 0, 5); // Start in Lobby Center

        // --- 3. LIGHTING (Global + Accents) ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));

        // --- 4. LUXURY INTERIOR (4M CEILING & BRICK) ---
        const brickMat = new THREE.MeshStandardMaterial({ color: 0x8b2222 }); // Red Brick
        const goldMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8 });

        function buildRoom(name, x, z, size, lightColor) {
            const group = new THREE.Group();
            // Floor & 4m Ceiling
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(size, size), new THREE.MeshStandardMaterial({color: 0x111111}));
            floor.rotation.x = -Math.PI/2;
            const ceil = new THREE.Mesh(new THREE.PlaneGeometry(size, size), new THREE.MeshStandardMaterial({color: 0x111111}));
            ceil.position.y = 4;
            ceil.rotation.x = Math.PI/2;
            group.add(floor, ceil);

            // Brick Wall
            const wall = new THREE.Mesh(new THREE.BoxGeometry(size, 4, 0.5), brickMat);
            wall.position.set(0, 2, -size/2);
            group.add(wall);
            P.add(wall); // Make it solid

            // Gold Pillar
            const p = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 4), goldMat);
            p.position.set(-size/2+0.5, 2, -size/2+0.5);
            group.add(p);
            P.add(p);

            const light = new THREE.PointLight(lightColor, 2, 15);
            light.position.set(0, 3.8, 0);
            group.add(light);

            group.position.set(x, 0, z);
            scene.add(group);
        }

        buildRoom("Lobby", 0, 0, 15, 0x00f2ff);
        buildRoom("Store", -18, 0, 12, 0xff00ff);
        buildRoom("Poker", 18, 0, 12, 0x00ff00);
        buildRoom("Vault", 0, 18, 12, 0xffd700);

        // --- 5. OCULUS CONTROLLERS ---
        const modelFactory = new XRControllerModelFactory();
        const cRight = renderer.xr.getController(0);
        const gRight = renderer.xr.getControllerGrip(0);
        gRight.add(modelFactory.createControllerModel(gRight));
        playerRig.add(cRight, gRight);

        // Right Trigger = OK Button
        cRight.addEventListener('selectstart', () => {
            console.log("OK Pressed");
            // Add interaction logic here
        });

        // --- 6. MOVEMENT SYSTEM (Left Thumbstick) ---
        function handleMovement() {
            const session = renderer.xr.getSession();
            if (!session) return;
            for (const source of session.inputSources) {
                if (source.gamepad && source.handedness === 'left') {
                    const axes = source.gamepad.axes;
                    const moveX = axes[2] || 0;
                    const moveZ = axes[3] || 0;
                    const nextPos = playerRig.position.clone();
                    const dir = new THREE.Vector3(moveX, 0, moveZ).applyQuaternion(camera.quaternion);
                    dir.y = 0;
                    nextPos.addScaledVector(dir, 0.1);
                    if (!P.check(nextPos)) playerRig.position.copy(nextPos);
                }
            }
        }

        // --- 7. WINNER UI LOGIC ---
        window.announceWinner = (name, hand) => {
            const ui = document.getElementById('win-notification');
            document.getElementById('winner-name').innerText = name + " WINS";
            document.getElementById('winner-hand').innerText = hand;
            ui.style.display = 'block';
            setTimeout(() => { ui.style.display = 'none'; }, 10000);
        };

        renderer.setAnimationLoop(() => {
            handleMovement();
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
