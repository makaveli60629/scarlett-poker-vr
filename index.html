<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker VR 1.8.5 - Hand Tracking & Teleport</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #VRButton { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 15px 30px !important; background: #111 !important; color: #fff !important;
            border: 2px solid #00ff00 !important; z-index: 1000; cursor: pointer;
        }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
        import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

        let scene, camera, renderer, baseGroup;
        let controller1, controller2, hand1, hand2;
        let raycaster = new THREE.Raycaster();
        const tempMatrix = new THREE.Matrix4();

        init();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky Blue

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // baseGroup allows us to move the player (teleport)
            baseGroup = new THREE.Group();
            baseGroup.add(camera);
            scene.add(baseGroup);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Force Hand Tracking support in the session
            document.body.appendChild(VRButton.createButton(renderer, { 'optionalFeatures': ['hand-tracking'] }));

            // LIGHTING
            const ambient = new THREE.HemisphereLight(0xffffff, 0x444444, 3);
            scene.add(ambient);

            buildWorld();
            setupInputs();

            renderer.setAnimationLoop(render);
        }

        function buildWorld() {
            // FLOOR
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(50, 50),
                new THREE.MeshStandardMaterial({ color: 0x333333 })
            );
            floor.rotation.x = -Math.PI / 2;
            floor.name = "Floor";
            scene.add(floor);

            // WALLS (Brick Red)
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x8B0000 });
            const wall = new THREE.Mesh(new THREE.BoxGeometry(10, 3, 0.2), wallMat);
            wall.position.set(0, 1.5, -5);
            scene.add(wall);

            // BLACK TRIM
            const trim = new THREE.Mesh(new THREE.BoxGeometry(10.1, 0.1, 0.1), new THREE.MeshStandardMaterial({color:0x000000}));
            trim.position.set(0, 0.05, -4.9);
            scene.add(trim);

            // POKER TABLE
            const table = new THREE.Mesh(
                new THREE.CylinderGeometry(1.2, 1.2, 0.2, 32),
                new THREE.MeshStandardMaterial({ color: 0x006400 })
            );
            table.position.set(0, 0.8, 0);
            scene.add(table);

            // EVENT CHIP ($5 Gold)
            const chip = new THREE.Mesh(
                new THREE.CylinderGeometry(0.04, 0.04, 0.02, 32),
                new THREE.MeshStandardMaterial({ color: 0xFFD700 })
            );
            chip.position.set(0, 0.92, -0.4);
            scene.add(chip);
        }

        function setupInputs() {
            const controllerModelFactory = new XRControllerModelFactory();
            const handModelFactory = new XRHandModelFactory();

            // Right Input (Controller + Hand)
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('selectstart', onSelectStart);
            baseGroup.add(controller1);

            hand1 = renderer.xr.getHand(0);
            hand1.add(handModelFactory.createHandModel(hand1, "mesh"));
            baseGroup.add(hand1);

            // Left Input (Controller + Hand)
            controller2 = renderer.xr.getController(1);
            baseGroup.add(controller2);

            hand2 = renderer.xr.getHand(1);
            hand2.add(handModelFactory.createHandModel(hand2, "mesh"));
            baseGroup.add(hand2);

            // Add Laser Pointer for Teleport
            const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]));
            line.scale.z = 10;
            controller1.add(line);
        }

        function onSelectStart() {
            // TELEPORT LOGIC
            tempMatrix.identity().extractRotation(controller1.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller1.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            const intersects = raycaster.intersectObjects(scene.children);
            for (let i = 0; i < intersects.length; i++) {
                if (intersects[i].object.name === "Floor") {
                    baseGroup.position.set(intersects[i].point.x, 0, intersects[i].point.z);
                    break;
                }
            }
        }

        function render() {
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
