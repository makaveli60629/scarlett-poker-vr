<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Poker - Permanent Foundation 1.3</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #111; }
        #canvas-container { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

        let scene, camera, renderer, userGroup;
        const handModels = [];

        init();

        function init() {
            // 1. SCENE & CAMERA SETUP
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505); // Dark background

            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 1000);
            
            // SPAWN POSITION: Moved back 1.2m and up 1.6m (eye level)
            userGroup = new THREE.Group();
            userGroup.position.set(0, 0, 1.2); 
            scene.add(userGroup);
            userGroup.add(camera);

            // 2. RENDERER SETUP
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            document.body.appendChild(VRButton.createButton(renderer));

            // 3. LIGHTING (Ensures no black screen)
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const spotLight = new THREE.PointLight(0xffffff, 1.5);
            spotLight.position.set(0, 3, 0);
            scene.add(spotLight);

            // 4. WORLD ELEMENTS (The Table)
            createTable();
            createFloor();

            // 5. HAND TRACKING (Locked-in: Hands only, no controllers)
            const handModelFactory = new XRHandModelFactory();
            
            for (let i = 0; i < 2; i++) {
                const hand = renderer.xr.getHand(i);
                hand.add(handModelFactory.createHandModel(hand, "mesh"));
                scene.add(hand);
                handModels.push(hand);
            }

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(render);
        }

        function createTable() {
            const tableGeo = new THREE.CylinderGeometry(1, 1, 0.05, 64);
            const tableMat = new THREE.MeshStandardMaterial({ color: 0x0a4d26, roughness: 0.8 });
            const table = new THREE.Mesh(tableGeo, tableMat);
            table.position.y = 0.9; 
            scene.add(table);
        }

        function createFloor() {
            const grid = new THREE.GridHelper(20, 40, 0x444444, 0x222222);
            scene.add(grid);
        }

        /** * PERMANENT WIN LOGIC (Update 1.3)
         * Call this to show the winner for 10 seconds.
         */
        window.showWinnerBanner = function(name, hand) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.fillStyle = 'gold';
            ctx.font = 'bold 40px Arial';
            ctx.fillText(name + " WINS!", 50, 60);
            ctx.font = '25px Arial';
            ctx.fillText(hand, 50, 100);

            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            sprite.position.set(0, 1.7, -0.5);
            sprite.scale.set(1, 0.25, 1);
            scene.add(sprite);

            // AUTO-REMOVE AFTER 10 SECONDS
            setTimeout(() => { scene.remove(sprite); }, 10000);
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function render() {
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
