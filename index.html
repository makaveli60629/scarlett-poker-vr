<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Scarlett VR Poker</title>

  <style>
    :root{
      --bg:#05060a;
      --panel:#0b0d14ee;
      --text:#e8ecff;
      --muted:#98a0c7;
      --aqua:#7fe7ff;
      --pink:#ff2d7a;
      --warn:#ffcc00;
      --bad:#ff6b6b;
      --ok:#4cd964;
      --radius:16px;
      --shadow: 0 14px 50px rgba(0,0,0,.55);
    }
    html, body {
      margin:0; padding:0; height:100%;
      background:var(--bg);
      overflow:hidden;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
    }
    canvas { display:block; }

    #VRButton, .vr-button {
      position: fixed !important;
      right: 12px !important;
      bottom: 12px !important;
      z-index: 9998 !important;
      border-radius: 14px !important;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial !important;
      box-shadow: var(--shadow) !important;
    }

    #dbg {
      position:fixed; left:12px; right:12px; top:12px;
      z-index:9999;
      pointer-events:auto;
      max-width: 1040px;
      margin: 0 auto;
    }
    #dbg .card{
      background:linear-gradient(135deg, rgba(11,13,20,.95), rgba(11,13,20,.75));
      border:1px solid rgba(127,231,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    #dbg .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    #dbg .title{
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:99px; background:var(--warn); display:inline-block; }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--bad); }

    #dbg .btns{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      appearance:none;
      border:none;
      border-radius:12px;
      padding:8px 10px;
      font-weight:700;
      cursor:pointer;
      background:rgba(127,231,255,.12);
      border:1px solid rgba(127,231,255,.22);
      color:var(--aqua);
    }
    button.alt{
      background:rgba(255,45,122,.10);
      border:1px solid rgba(255,45,122,.22);
      color:var(--pink);
    }
    button.dim{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      font-weight:600;
    }
    button:active{ transform: translateY(1px); }

    #dbg .body{
      padding:10px 12px 12px 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    #env{
      display:flex; flex-wrap:wrap; gap:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    #log{
      height: 210px;
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      color:#e8ecff;
    }
    .kv{
      display:inline-flex; gap:6px; align-items:center;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
    }
    .k{ color:var(--muted); }
    .v{ color:var(--text); }
  </style>

  <!-- ✅ IMPORT MAP FIX:
       This makes `import * as THREE from "three"` work on GitHub Pages + Quest.
       It points "three" to your local module wrapper at /js/three.js -->
  <script type="importmap">
  {
    "imports": {
      "three": "./js/three.js"
    }
  }
  </script>
</head>

<body>
  <div id="dbg">
    <div class="card">
      <div class="top">
        <div class="title">
          <span>SCARLETT VR POKER — DEBUG BOOT</span>
          <span class="pill"><span id="stDot" class="dot"></span><span id="stText">Booting…</span></span>
          <span class="pill"><span class="k">v</span><span id="ver" class="v">?</span></span>
        </div>
        <div class="btns">
          <button class="dim" id="btnToggle">Hide</button>
          <button class="dim" id="btnClear">Clear</button>
          <button class="alt" id="btnReload">Reload + CacheBust</button>
        </div>
      </div>

      <div class="body" id="dbgBody">
        <div id="env"></div>
        <div id="log"></div>

        <div style="color:var(--muted); font-size:12px; line-height:1.35;">
          <b style="color:var(--text);">If VR button is missing:</b> main.js didn’t load or the browser doesn’t support immersive-vr.
          <br/>This panel shows the exact import error.
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const logEl = document.getElementById("log");
      const envEl = document.getElementById("env");
      const stDot = document.getElementById("stDot");
      const stText = document.getElementById("stText");
      const verEl = document.getElementById("ver");
      const btnToggle = document.getElementById("btnToggle");
      const btnClear = document.getElementById("btnClear");
      const btnReload = document.getElementById("btnReload");
      const dbgBody = document.getElementById("dbgBody");

      const params = new URLSearchParams(location.search);
      const v = params.get("v") || String(Date.now());
      verEl.textContent = v;

      function setStatus(kind, text){
        stText.textContent = text;
        stDot.classList.remove("ok","bad");
        if (kind === "ok") stDot.classList.add("ok");
        if (kind === "bad") stDot.classList.add("bad");
      }
      function safe(x){
        try{
          if (x instanceof Error) return (x.stack || x.message || String(x));
          if (typeof x === "object") return JSON.stringify(x);
          return String(x);
        }catch(e){ return String(x); }
      }
      function append(line){
        const t = new Date().toLocaleTimeString();
        logEl.textContent += `[${t}] ${line}\n`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      const _log = console.log, _warn = console.warn, _err = console.error;
      console.log = (...a)=>{ _log(...a); append("LOG  " + a.map(safe).join(" ")); };
      console.warn = (...a)=>{ _warn(...a); append("WARN " + a.map(safe).join(" ")); };
      console.error = (...a)=>{ _err(...a); append("ERR  " + a.map(safe).join(" ")); };

      window.addEventListener("error", (e) => {
        setStatus("bad", "Runtime error");
        console.error("window.error:", e.message, e.filename, e.lineno+":"+e.colno);
      });
      window.addEventListener("unhandledrejection", (e) => {
        setStatus("bad", "Promise rejection");
        console.error("unhandledrejection:", e.reason);
      });

      btnToggle.onclick = () => {
        const hidden = dbgBody.style.display === "none";
        dbgBody.style.display = hidden ? "grid" : "none";
        btnToggle.textContent = hidden ? "Hide" : "Show";
      };
      btnClear.onclick = () => { logEl.textContent = ""; };
      btnReload.onclick = () => {
        const u = new URL(location.href);
        u.searchParams.set("v", String(Date.now()));
        location.href = u.toString();
      };

      const isSecure = window.isSecureContext;
      const hasXR = !!navigator.xr;
      envEl.innerHTML = [
        kv("secureContext", isSecure ? "YES" : "NO"),
        kv("navigator.xr", hasXR ? "YES" : "NO"),
        kv("platform", navigator.platform || "n/a"),
        kv("href", location.href),
      ].join("");

      function kv(k, v){
        return `<span class="kv"><span class="k">${esc(k)}:</span><span class="v">${esc(String(v))}</span></span>`;
      }
      function esc(s){
        return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
      }

      console.log("BOOT", { v, secureContext:isSecure, xr:hasXR });

      setStatus("warn", "Loading main.js…");
      const mainPath = "./js/main.js?v=" + encodeURIComponent(v);

      import(mainPath).then(() => {
        setStatus("ok", "main.js loaded ✅");
        console.log("main.js import ✅", mainPath);

        setTimeout(() => {
          const hasVRBtn = !!document.getElementById("VRButton") || !!document.querySelector(".vr-button");
          if (!hasVRBtn) {
            console.warn("VRButton not found in DOM (main may have crashed after import).");
            setStatus("bad", "No VR button");
          }
        }, 1200);
      }).catch((err) => {
        setStatus("bad", "main.js failed to load");
        console.error("FAILED TO IMPORT", mainPath, err);
      });
    })();
  </script>
</body>
</html>
